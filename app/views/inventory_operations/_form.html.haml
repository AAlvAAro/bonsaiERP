:css
  #items_table .input{
    margin: 2px 0px;
  }

= simple_form_for(@inventory_operation) do |f|
  = bonsai_form_error(f)

  = f.input :operation, :as => :hidden
  = f.input :store_id, :as => :hidden
  = f.input :transaction_id, :as => :hidden

  .main.bg_light_grey
    .input
      = f.input :ref_number, :input_html => {:size => 20}
      = f.input :date

    - url, title = @inventory_operation.operation == "in" ? [new_supplier_path, "Nuevo proveedor"] : [new_client_path, "Nuevo cliente"]

    - if @inventory_operation.transaction_id.blank?
      = f.association :contact, :collection => @inventory_operation.get_contact_list, :label => @inventory_operation.contact_label,
        :input_html => { 'data-new_url' => url, 'data-title' => title, 'data-trigger' => 'new_contact' }
    - else
      .input
        = f.input :contact_id, :as => :hidden
        %label Contacto
        = link_to f.object.contact, f.object.contact, :target => '_blank'
    .clear

  = f.input :description, :as => :text, :input_html => {:rows => 4, :cols => 40}
  .clear

  %table.decorated#items_table
    %tr
      %th Item
      %th Cantidad
      %th Inventario
      %th

    - if @inventory_operation.transaction_id.blank?
      - @items = Item.inventory.org
      = render "form_details", :f => f
    - else
      = render "form_details_transaction", :f => f

  - if @inventory_operation.transaction_id.blank?
    %p
      <a href="javascript:" id="add_item" class="add">Adicionar ítem</a>
  .actions
    = f.submit 'Salvar'

:javascript
  head.ready(function() {
    $('#add_item').live('click', function() {
      var t = (new Date() ).getTime();
      tr = $('#items_table tr.item:first').clone();
      tr.find("input, select").each(function(i, el) {
        var name = $(el).attr("name").replace(/\d+/, t);
        $(el).attr("name", name);
      });
      tr.appendTo("#items_table");
    });

    // Delete an item from an inventory
    $('#items_table a.destroy').live('click', function() {
      if( $('tr.item').length <= 1 ) {
        alert("Debe existir al menos un ítem");
        return false;
      }else{
        $(this).parents('tr:first').remove();
      }
    });

    // New contact
    $('body').live('new_contact', function(e, resp) {
      $('#inventory_operation_contact_id').createSelectOption(resp.id, resp.matchcode);
    });


    // new_item trigger
    $('body').live('new_item', function(e, resp) {
      $('#items_table select').each(function(i, el) {
        $(el).append([ '<option value="', resp.id ,'">', resp.code, ' - ', resp.name , '</option>' ].join("") );
      });
      var tr = $('#items_table').data('row');
      tr.find('select').val(resp.id).mark().trigger('change');
    });

    // Remember the row for the clicked new item
    $('#items_table a.add').live('click', function() {
      $('#items_table').data('row', $(this).parents('tr:first') );
    });

    // Present the list of stocks for the store
    var stocks = #{ @inventory_operation.store.get_hash_of_items.to_json};
    $('#items_table select').live('change keyup', function() {
      var val = 1 * $(this).val();
      val = stocks[val] || {'quantity': 0};
      $(this).parents('td').siblings('td.inventory').html(  _b.ntc( val.quantity ) );
    });
 
  });
