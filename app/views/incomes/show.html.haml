- content_for :links do
  %ul.breadcrumbs.span6
    %li
      = link_to "Ingresos", incomes_path
    %li
      %i.icon-caret-right
    %li
      = @income

%header
  - if @income.has_error
    .alert.alert-error
      %h4 Existen errores que debe corregir!
      %ul
        - @income.error_messages.each do |k, arr|
          - arr.each do |v|
            %li
              %h5.n.devolution-error= I18n.t("allowed_errors.#{v}").html_safe

.row-fluid
  .span7
    %h1.ib
      %strong(title='Código ingreso, Ingreso-Año-Número' data-toggle='tooltip')= @income
      %small(title='Estado' data-toggle='tooltip')= @income.state_tag

    %h4.ib.n
      = link_to @income.contact, @income.contact, title: 'Contacto', data: {toggle: 'tooltip'}

    .clearfix
    %h5.n.ib
      %span.muted Fecha:
      %i= lo @income.date
      = render_if @income.due_date do
        = @income.due_date_tag

      = @income.updater_label

      = @income.creator_label

      = @income.approver_label

      = @income.nuller_label

  .span5.r
    -# Approve form
    - if @income.is_draft?
      = form_for @income, url: approve_income_path(@income), html: {class: 'ib'} do |f|
        = f.submit 'Aprobar', class: 'b btn btn-success'
    -# Null form
    - if @income.can_null?
      = form_for @income, url: null_income_path(@income), html: {class: 'ib', id: 'null-income-form'} do |f|
        = f.submit 'Anular', class: 'b btn btn-danger'
    .btn-group
      = link_to income_path(@income.id, format: 'print'), class: 'btn' do
        %i.icon-print
        Imprimir

      = link_to income_path(@income.id, format: 'pdf'), class: 'btn' do
        = image_tag 'pdf.png', width: '16'
        PDF

      = link_to icon_edit_text, edit_income_path(@income.id), class: 'btn' unless @income.is_nulled?

.row-fluid
  .span6
    .moneybox
      %label TOTAL
      %h5.n
        = ntc @income.total
        = currency_label @income.currency

    .moneybox
      %label SALDO
      %h5.n
        %span#balance(data-amount="#{@income.balance}")= ntc @income.balance
        = currency_label @income.currency

    - unless OrganisationSession.currency === @income.currency
      .clearfix
      %span.muted
        %i.icon-exchange
        Tipo de cambio:
      1
      = currency_label @income.currency
      \=
      = ntc @income.exchange_rate, precision: 4
      = currency_label

  .span6
    %span.muted Proyecto:
    = link_to @income.project, @income.project if @income.project
    .clearfix
    %i.icon-file.muted(data-toggle='tooltip' title='Descripción')
    = @income.description


%h2.n
  Items

= render "incomes/items", income: @income

= @income.pendent_conciliations

.row-fluid
  .span6.well.well-small.bg-white
    %h3.n.ib
      Cobros y devoluciones

    &nbsp;
    &nbsp;
    %a#show-payments(href='javascript:;' data-url="#{}")
      Ver cobros y devoluciones

    .payment-form.form-container.ajax-modal

    %p.center.payment-buttons

      - if @income.can_pay?
        = link_to class: 'btn btn-success w100p', data: {remote: true, url: new_income_payment_path(@income.id) } do
          %i.icon-plus-sign
          Cobrar

      - if @income.can_devolution?
        = link_to class: 'btn btn-danger w100p', data: {remote: true, url: new_income_devolution_path(@income.id) } do
          %i.icon-minus-sign
          Devolución

    %ul.unstyled.listing
      = render partial: 'account_ledgers/movement2', collection: @income.payments_and_devolutions, as: :ledger

  .span6.well.well-small.bg-white
    %h3.n.ib
      Operaciones inventario

    &nbsp;
    &nbsp;
    %a#show-inventory(href='javascript:;' data-url="#{}")
      Ver operaciones de inventario


-#Tours
= render 'incomes/tour_devolution'

:javascript
  $( function() {
    // null income
    $('#null-income-form').submit(function(event) {
      if(confirm('Esta segur@ de anular el Ingreso?')) {
        return true;
      }else{
        return false;
      }
    })

    // Payment buttons
    $('.payment-buttons').on('click', 'a', function() {
      $this = $(this);
      $('.payment-buttons').hide('fast');
      $('.payment-form')
      .html('<p class="center muted"><img src="/assets/ajax-loader.gif" /> Cargando...</p>')
      .load($this.data('url'), function() { $('.payment-form').setDatepicker() });
    })

    $('.payment-form').on('click', 'a.cancel', function() {
      $('.payment-buttons').show('fast');
      $('.payment-form').html('');
    })


    // Payment show hide
    $('#payment-link').click( function() {
      $('#payment-form').show('fast');
    })
    $('body').on('click', '#cancel-payment-link', function() {
      $('#payment-form').hide('fast');
      $('.payment-buttons').show('fast');
    });

    // Devolution show hide
    $('#devolution-link').click( function() {
      $('#devolution-form').show('fast');
      $('.payment-buttons').hide('fast');
    })
    $('body').on('click', '#cancel-devolution-link', function() {
      $('#devolution-form').hide('fast');
      $('.payment-buttons').show('fast');
    });
  });
